datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum UserRole {
  CUSTOMER
  DRIVER
  BOTH
}

enum DriverStatus {
  PENDING
  APPROVED
  SUSPENDED
  REJECTED
}

enum OrderStatus {
  OPEN
  ACCEPTED
  PICKED_UP
  DELIVERED
  CANCELLED
  EXPIRED
}

enum BackgroundCheckStatus {
  NOT_STARTED
  PENDING
  PASSED
  FAILED
}

model User {
  id                  String    @id @default(cuid())
  clerkId             String    @unique
  email               String    @unique
  name                String
  phone               String?
  phoneVerified       Boolean   @default(false)
  role                UserRole  @default(CUSTOMER)
  avatarUrl           String?
  stripeCustomerId    String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  driverProfile       DriverProfile?
  ordersAsCustomer    Order[]         @relation("CustomerOrders")
  ordersAsDriver      Order[]         @relation("DriverOrders")
  ratingsGiven        Rating[]        @relation("RatingsGiven")
  ratingsReceived     Rating[]        @relation("RatingsReceived")
  notifications       Notification[]
}

model DriverProfile {
  id                    String               @id @default(cuid())
  userId                String               @unique
  user                  User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  status                DriverStatus         @default(PENDING)
  licenseNumber         String?
  licenseState          String?
  licenseExpiry         DateTime?
  vehicleMake           String?
  vehicleModel          String?
  vehicleYear           Int?
  vehicleColor          String?
  vehiclePlate          String?
  backgroundCheckStatus BackgroundCheckStatus @default(NOT_STARTED)
  backgroundCheckId     String?
  stripeConnectId       String?
  totalDeliveries       Int                  @default(0)
  averageRating         Float                @default(0)
  totalEarnings         Int                  @default(0)
  currentLatitude       Float?
  currentLongitude      Float?
  isOnline              Boolean              @default(false)
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt
}

model Order {
  id                  String      @id @default(cuid())
  customerId          String
  customer            User        @relation("CustomerOrders", fields: [customerId], references: [id])
  driverId            String?
  driver              User?       @relation("DriverOrders", fields: [driverId], references: [id])

  storeName           String
  storeAddress        String
  storeCity           String
  storeState          String
  storeZip            String
  storeLatitude       Float
  storeLongitude      Float
  storePlaceId        String?

  itemDescription     String
  itemPhotoUrl        String?
  storeOrderId        String
  pickupName          String
  pickupInstructions  String?

  deliveryAddress     String
  deliveryCity        String
  deliveryState       String
  deliveryZip         String
  deliveryLatitude    Float
  deliveryLongitude   Float
  deliveryPlaceId     String?
  deliveryInstructions String?

  distanceMiles       Float
  offerAmountCents    Int
  priceHistory        Json         @default("[]")
  driverEarningsCents Int?

  status              OrderStatus  @default(OPEN)
  stripePaymentIntentId String?

  createdAt           DateTime     @default(now())
  expiresAt           DateTime
  acceptedAt          DateTime?
  pickedUpAt          DateTime?
  deliveredAt         DateTime?
  cancelledAt         DateTime?
  updatedAt           DateTime     @updatedAt

  ratings             Rating[]

  @@index([status])
  @@index([customerId])
  @@index([driverId])
}

model Rating {
  id          String   @id @default(cuid())
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id])
  fromUserId  String
  fromUser    User     @relation("RatingsGiven", fields: [fromUserId], references: [id])
  toUserId    String
  toUser      User     @relation("RatingsReceived", fields: [toUserId], references: [id])
  stars       Int
  comment     String?
  tags        String[] @default([])
  createdAt   DateTime @default(now())

  @@unique([orderId, fromUserId])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String
  message   String
  orderId   String?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId, read])
}
